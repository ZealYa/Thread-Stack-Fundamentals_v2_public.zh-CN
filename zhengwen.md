# **Thread协议栈基础**

2015年7月

# 引言

---

## 基本特性

Thread协议栈是一个可靠，低成本，低功耗，无线D2D（设备到设备）的开放通信标准。
它是专为基于IP的网络连接运行的家庭应用而设计，并且基于协议栈可运行多种应用。

以下是Thread协议栈和网络的基本特点：

* 简化网络的安装，启动和运行：形成，加入和维护Thread网络的简单协议，
  允许系统自行配置并自行修复路由问题。
* 安全性：除非经过授权，否则设备无法加入Thread网络；并且所有通信都经过加密和保护。
* 小型和大型网络：家庭网络设备之间的无缝连接在几个到几百个之间变化。
  基于预期使用环境，Thread的网络层设计时就优化了网络操作。
* 范围：常规的设备结合网状网络足够提供覆盖一个普通家庭的范围。
  物理层采用扩频技术，提供良好的抗干扰能力。
* 无单一故障点：即使在单个设备发生故障或丢失的情况下，协议栈也可以提供安全可靠
  的操作。
* 低功耗：在合适的工作/休眠周期中，设备通常可以使用AA型电池工作几年。

[图1](#_bookmark1)为Thread协议栈的系统框架

![](/assets/图1.Thread协议栈的概述.png)

**图1.Thread协议栈系统框架**

## IEEE 802.15.4

该标准基于在2.4GHz频带中以250kbps运行的IEEE 802.15.4[\[IEEE802154\]](https://standards.ieee.org/findstds/standard/802.15.4-2006.html)
PHY（物理）和MAC（媒体访问控制）层。Thread协议栈采用的是IEEE 802.15.4-2006版本。

所述802.15.4 MAC层用于基本的消息处理和拥塞控制。MAC层包括设备用于监听干净信道的CSMA（Carrier Sense Multiple Access，载波侦听多路访问）机制，
以及用于相邻设备之间可靠通信的（处理重试和确认消息的）链路层。
基于由协议栈的上层建立和配置的密钥，被MAC层用于对消息的加密和完整性保护。
网络层建立在这些基础机制上，以在网络中提供可靠的端对端通信。

## 无单点故障

由运行Thread协议栈设备组成的系统中，所有在系统中的设备都无法形成单点故障[^spf]。
网络中有许多设备执行特殊功能，但是Thread协议栈的设计使得它们可以被替换，而不会影响
Thread网络中正在进行的通信。例如，一个休眠的子设备需要一个父设备进行通信，
因此这个父设备对它的通信来说是单点故障。但是对于Thread网络来说，如果常眠设备的父设备不可用，
常眠设备可以并会选择另一父设备，且该转换对用户不可见。

虽然系统设计无单点故障，但在某些拓扑结构下，特定设备的角色将无法被其他设备替代。
例如，在单个网关的系统中，如果网关断电，将无法切换到另一个网关。

路由器或边界路由器可以为Thread网络中的某些功能承担Leader角色。此Leader需要对网络内相关操作作出决定。
例如，Leader分配路由角色地址并允许新的路由角色请求。Leader角色是被选举的，如果Leader设备失效，
会由另一个路由器或边界路由器承担Leader角色。正是这种自主操作确保了Thread网络没有单点故障。

[^spf]:单点故障（single point of failure），从英文字面上可以看到是单个点发生的故障，通常应用于计算机系统及网络。
实际指的是单个点发生故障的时候会波及到整个系统或者网络，从而导致整个系统或者网络的瘫痪。这也是在设计IT基础设施时应避免的。

# 设备类型
---
## 边界路由器

边界路由器是一种特定类型的路由器，提供从802.15.4网络到其他不同物理层（例如，Wi-Fi和以太网）的相邻网络上的的连接。
边界路由器为802.15.4网络中的设备提供服务，包括用于离线操作（off-network operations）的路由服务。Thread网络中可能存在一个或多个边界路由器。

## 路由器

路由器为网络设备提供路由服务。路由器还为尝试加入网络的设备提供入网和安全服务。路由器是设计为不休眠的。
路由器可以降级其功能并成为REED（Router-eligible End Devices，具备路由能力的终端设备）。

## 具备路由能力的终端设备

REED有能力成为路由器，但是由于网络拓扑或条件，这些设备不作为路由器工作。
这些设备通常不转发消息也不为Thread网络中的其他设备提供加入或安全服务。如果需要，Thread网络管理REED成为路由器，且无需用户交互。

## 休眠终端设备

休眠终端设备是主机设备。他们只通过他们的父路由器进行通信，不能转发其他设备的消息

# IP协议栈基础

---

## 寻址

Thread协议栈中的设备支持[\[RFC 4291\]](https://www.ietf.org/rfc/rfc4291)中指定的IPv6寻址架构。
设备配备1个或多个ULA（唯一本地地址）或GUA（全局单播地址）。
启动网络的设备挑选一个/64前缀，在整个Thread网络使用。前缀是本地分配的全局ID，通常称为ULA前缀
[\[RFC 4193\]](https://www.ietf.org/rfc/rfc4193)，或被称为Mesh本地ULA前缀。
Thread网络还可以具有一个或多个边界路由器，每个边界路由器可选择是否拥有（用于生成额外GUA的）前缀。
在Thread网络的设备使用其扩展MAC地址来导出[\[RFC 4944\]](https://www.ietf.org/rfc/rfc4944)第6节中定义的接口标识符。
且基于此，通过已知的本地前缀FE80 :: 0/64配置本地链路IPV6地址，如[\[RFC 4862\]](https://www.ietf.org/rfc/rfc4862)
和[\[RFC 4944\]](https://www.ietf.org/rfc/rfc4944)所述。

该器件还支持相应的组播地址。这包括链路本地所有节点组播，链路本地所有路由器组播和区域本地组播。

每个加入Thread网络的设备将会被分配一个16位地址[\[IEEE802154\]](https://standards.ieee.org/findstds/standard/802.15.4-2006.html)。
对路由器设备而言，该地址使用地址字段中的高位，而低位设置为0，表示路由器地址。
而后，子设备将使用其父设备的高位地址编码和适当的低位地址编码来为其地址配置一个16位的短地址。
这允许Thread网络中的任何其他设备通过使用其地址字段的高位来判断子设备的路由（父设备）位置。
[图2](#_bookmark13) 说明Thread短地址构造。
![](/assets/短地址.png)
**图2.Thread短地址**

## 6LoWPAN

所有设备使用[\[RFC 4944\]](https://www.ietf.org/rfc/rfc4944) 和 [\[RFC 6282\]](https://www.ietf.org/rfc/rfc6282)中定义的6LoWPAN。

Thread网络中使用报头压缩（Header compression）技术，设备在传输消息尽可能多地压缩IPv6报头，使发送的数据包的大小最小化。

如[**路由和网络连接**](#_bookmark20)所讨论的，mesh报头支持在Mesh网络实现对链路层转发消息的更有效的压缩。
mesh报头也允许端至端的消息分片，而不是如[\[RFC 4944\]](https://www.ietf.org/rfc/rfc4944)中所述的逐跳分片。
Thread协议栈使用路由切换配置[route-over configuration]。

设备不​​支持[\[RFC 6775\]](https://www.ietf.org/rfc/rfc6775)所述的邻居发现，而使用DHCPv6用于实现路由器的地址分配。
终端设备和REED由其路由父节点分配短地址。然后将该短地址被用于配置实现网内通信的mesh本地网络ULA。

有关6LoWPAN使用和配置的更多详细信息，请参见“6LoWPAN的Thread用法（Thread Usage of 6LoWPAN）”白皮书。
Thread规范的第3章详细介绍了所使用的6LoWPAN具体配置。


## ICMP

设备支持的ICMPv6（因特网控制消息协议版本6）协议[\[RFC 4443\]](https://www.ietf.org/rfc/rfc4443)及ICMPv6的错误消息，以及回显请求和回显回复消息。

## UDP

Thread协议栈支持[\[RFC 768\]](https://www.ietf.org/rfc/rfc768)中定义的UDP（用户数据报协议），用于设备之间的消息传递。

# 网络拓扑

---

## 网络地址和设备

Thread栈支持Thread网络的所有路由器之间的全连通。

实际的拓扑结构是取决于Thread网络中路由器的数量。如果只有一个路由器或边界路由器，则形成仅有单个路由器的基本星形拓扑。
如果有一个以上的路由器将自动形成一个网状拓扑。[图3](#_bookmark18)说明了Thread网络的基本拓扑结构和设备的类型。
![](/assets/基本主题的网络拓扑和设备.png)

**图3.典型的网络拓扑和设备**

## 网状网络

Mesh网络允许通过射频节点转发其他射频节点的消息，使射频通信系统更可靠。
例如，如果一个节点不能直接将消息发送到另一个节点，Mesh网络将通过一个或多个中间节点转发该消息。
如[**路由和网络连接**](#_bookmark20)部分讨论的，Thread网络的本质是，所有路由器节点维护与彼此之间的路由和连接，所以Mesh是一直维持和连接的。
Thread网络中有最多32个活动路由器的限制。但是，具有64个路由器地址用于实现路由器地址循环利用。在Mesh网络中，睡眠终端设备或其他REED设备不具备路由功能。
这些设备将消息发送到父路由设备。该父路由设备负责处理其子设备的路由操作。

# 路由和网络连接

---

Thread网络通常具有用于基于所述设备的路由表的消息的下一跳路由多达32个活性路由器。该设备的路由表被电池堆维护，以确保所有路由器都具有连接和高达最新路径在螺纹网络的任何其他路由器。的RIP（路由信息协议）算法（算法从

[\[RFC 1058\]](https://www.ietf.org/rfc/rfc1058)和[\[RFC 2080\]](https://www.ietf.org/rfc/rfc2080)但不是特定的消息格式）。所有路由器与其他路由器交换它们用MLE压缩格式路由到其他路由器在网络Thread的成本（mesh链路建立）。

**注意：**从知识产权的角度看，螺纹网络支持路由器和主机。主机要么是困终端设备或簧片。

## MLE消息

MLE的消息（见[\[草案-凯尔-intarea目链路建立-06\]](https://datatracker.ietf.org/doc/draft-kelsey-intarea-mesh-link-establishment/)这是在第4章延长线，消息链路的建立，所述螺纹规格的）被用于建立和配置安全的无线链路，检测相邻设备，并保持在Thread的网络设备之间的路由的成本。MLE消息使用单跳链路路由器之间的本地单播和多播传输。

MLE消息被用于识别，配置和固定联结到邻近设备作为拓扑和物理环境的变化。MLE还用于分发在跨越Thread共享网络诸如信道和PAN（个人区域网）的ID的配置值。这些消息可以用简单的驱通过MPL（组播协议用于低功率有损网络）中指定的转发。（看到[\[草案-IETF-辊滴入MCAST-09\]](https://tools.ietf.org/html/draft-ietf-roll-trickle-mcast-09)了解更多信息。）

MLE消息也确保两个设备之间建立路由成本时，非对称链路的成本考虑。非对称链路成本是802.15.4网络中很常见。为了确保单向消息二是可靠的，考虑双向链路的成本是非常重要的。

## 路由发现和修复

在按需路由发现在低功耗802.15.4网络常用。然而，按需路由发现网络开销和带宽方面的成本由于路由发现请求充斥网络。

在一个Thread网络，所有的路由器周期性地交换包含链路成本信息给所有的邻居路由器的单跳MLE通告报文和路径成本在Thread网络的其它路由器。通过这些周期性的，本地更新，所有的路由器都必须跟上时代的路径成本信息的任何其他路由器在网络Thread，所以点播不需要路由发现。如果路由不再可用，路由器可以对到目的地的下一个最合适的路径选择。这种自愈路由机制允许路由器快速检测时，其他路由器都下车Thread网络，并计算出最佳路径，以保持连接性的主题网络的所有其他设备。

在每个方向上的链路质量是基于从该邻近设备的传入消息的链路成本。这个呼入链路成本被映射到的链路质量从0到3的值0意味着未知成本。的链路成本是接收电平以上的接收消息RSSI（接收信号强度指示符）的测量。

[表格1](#_bookmark23)总结链路质量和链路成本。

**表1.链路质量和链路成本**

| **链路质量** | **链路成本** |
| :--- | :--- |
| 0 | 未知 |
| 1 | 6 |
| 2 | 2 |
| 3 | 1 |

[图4](#_bookmark24)说明Thread网络上的各种链路成本的例子。

![](/assets/各种链路成本实例.png)

**图4的各种链路成本的实例Thread网络上**

路径成本在Thread网络的任何其他节点则链路成本最小总和达到该节点。路由器监控这些成本，即使网络变化的无线链路质量或拓扑结构，并通过传播Thread网络使用周期MLE通告消息新的成本。路由开销是基于两个设备之间的双向链路质量。

为了说明通过一个简化的例子，假设与在所有设备都在同一时间上电共享安全材料预委托网络。每个路由器将定期发送最初只与成本单跳邻居填充的广告。在内部，每个路由器将存储未在广告中发送的下一跳信息。

最初的几个广告，将有路径成本等于环节的成本，因为这是唯一已知的路由器是在说明近邻[图5](#_bookmark25)。

![](/assets/成型电后Thread网络.png)

**图5.成型电后Thread网络**

但随着路由器开始从他们的邻居包含成本是两个或更多的跳之外的其他路由器听到的广告，他们的桌子多跳路径成本填充，然后传播甚至更远的地方，直到最终出现在所有路由器之间的连接信息网络，如所示[图6](#_bookmark26)和[图7](#_bookmark27)。

![](/assets/主题网络形成：路由通告.png)

**图6.主题网络形成：路由通告**

![](/assets/主题网络形成：多跳.png)

**图7.主题网络形成：多跳**

当路由器从邻居接收到一个新的MLE的广告，无论是它已经用于该设备的邻居表项或一个加入。该MLE广告包含从邻居所以这是在路由器的邻居表更新传入的成本。该MLE

广告还包含其他路由器更新的路由信息​​，并且这些信息在设备中路由表的更新。

路由到子设备通过观察孩子的地址的高位来确定母路由器地址来实现。一旦设备知道母路由器，它拥有该设备的路径成本信息和下一跳路由信息。

活性路由器的数量被限制为可包含在单个802.15.4分组路由和成本信息的量。此限制是目前32个路由器但提供64活性的路由器地址，以允许老化出路由器地址。

## 路由

设备使用IP路由转发数据包。的装置的路由表被填充有网状本地地址ULA用于路由器和相应的下一跳的压缩形式。

距离矢量路由是用来获取路由路由器是Thread网络上的地址。当Thread网络上的路由，该16位地址的高6位定义了目的区路由器的路由器地址。如果目的地址的较低位为0，则该路由器是最终的目的地。否则，目标路由器负责把基于16位目标地址的低位的最终目的地。

为了路由超越Thread网络，边界路由器通知特定的前缀（ES），它服务的领导者和该信息分布的MLE包内螺纹网络数据。Thread网络数据包括：前缀的数据，这是前缀本身，6LoWPAN的情况下，边界路由器，并为前缀的DHCPv6服务器。如果设备配置使用前缀的IPv6地址，它使用SLAAC（无状态地址自动配置）或接触此相应的DHCP（动态主机配置协议）服务器。Thread网络数据还包括路由服务器，这是默认的边界路由器的路由器地址的列表。

一个领导者指定的选择芦苇成为路由器或允许路由器恢复到芦苇做决定。该负责人还负责分配和管理路由器的地址。然而，包含在该路由负责人的所有信息出现在其他路由器，如果路由负责人不可达，另一台路由器自动当选，接任领导无需用户干预。

## 重试和确认

而UDP消息在Thread协议栈所使用的，可靠的消息传递仍是必需的。这是通过一系列轻巧的机制做如下：

·MAC级重试：每个设备从下一跳使用MAC确认和在MAC层，如果没有接收到MAC ACK消息将重试的消息。

·应用级重试：应用程序级可确定是否消息可靠性是关键参数，并且如果必要可以实现其自己的重试机制。

# 加入一个Thread网络

---

有一个连接装置必须经历才可以参加主题网络中的各个阶段：

* ·发现
* ·调试
* ·附上

所有加盟是用户发起的主题网络。一旦加入，将设备完全参与Thread网络，可与内外Thread网络与其他设备和服务的交换应用层信息。

**发现**

结合装置具有发现Thread网络，并与调试路由器建立联系。接合装置扫描所有信道，发出各通道上的信标请求，并等待信标应答。信标包含包括网络的SSID（服务集标识符）和表示如果Thread网是接受新成员的许可证接合信标有效载荷。一旦设备发现了主题网络，它使用MLE的信息来建立，通过它可以进行调试相邻路由器。

如果该设备已获得调试信息，因为它已经有足够的信息来直接连接到网络Thread不需要发现。

**调试**

主题提供了两种调试方法：

* ·直接配置调试信息到使用了带外的方法的装置。调试信息允许加入设备尽快将其引入到网络连接到正确的Thread网络。

* ·建立接合装置和智能电话，平板试运行的应用程序，或网络之间的调试会话。调试会话安全提供调试信息到连接设备，允许其在完成调试会话后连接到正确的Thread网络。

**注意：**通过允许在信标有效载荷接合标志仅接合的典型802.15.4方法没有一个Thread网络使用。这种方法是最常用的按钮式接合在没有用户界面或外的带外信道给设备。这种方法可能与在有多个网络可用，也形势设备转向问题可能有安全问题。

**附上**

与调试信息的结合装置，使具有父路由器接触，然后通过交换MLE链路配置消息附加到经由父路由器Thread网络。设备连接到一个Thread网作为任一终端设备或REED和分配由父路由器16位短地址使用中所示[图8](#_bookmark34)。

![](file:///C:\Users\jerry\AppData\Local\Temp\msohtmlclip1\01\clip_image010.gif "Description: C:\work\Thread Group \(2015\)\\(2015\_T04\_002\) Thread Specification Writing\_2\white papers\figures\TSF\_Attaching to a Network with Known Key.png")![](/assets/附加到Thread网络与已知的钥匙.png)

**图8.附加到Thread网络与已知的钥匙**

一旦里德连接，它可以紧接着将其分配由领导路由器地址可能发出一个地址请求成为一个路由器。

**MLE消息**

一旦设备连接到网络Thread，有各种信息需要它来维持它在网络中的参与。MLE提供服务，整个邻居之间的网络交流环节的成本和安全框架柜台分发网络数据。

该MLE邮件分发或交换以下信息：

* ·相邻装置的16位短和64位EUI 64长地址
* ·设备能力信息包括：如果它是一个困端设备和所述困倦主机设备的睡眠周期
* ·邻居的链路成本（如路由器）
* ·设备之间的安全材料和帧计数器
* ·路由成本到所有其它路由器在网络Thread
* ·更新网络数据，如在MAC中使用的信道，PAN ID和信标有效载荷参数

**注意：**MLE消息进行加密，除了发现在接合装置已经获得了所需的安全材料之前。

**DHCPv6报**

DHCPv6报[\[RFC 3315\]](https://www.ietf.org/rfc/rfc3315)是一个基于UDP的客户端 - 服务器协议来管理网络内的设备的配置。的DHCPv6使用UDP从DHCP服务器请求数据。

在边界路由器能DHCPv6服务用于配置：

* ·网络地址
* ·通过设备所需的多播地址
* ·主机服务

# **管理**

---

**ICMP**

所有设备都支持的ICMPv6的错误消息，以及回波请求和Echo Reply消息。

**设备管理**

一个设备上的应用层可以访问一组设备管理和诊断信息，可以在本地使用或者收集并发送至其他管理装置。

从802.15.4 MAC层中使用由Thread的信息包括：

* ·EUI 64个地址
* ·16位短地址
* ·能力信息
* ·PAN ID
* ·数据包发送和接收
* ·包掉在发送或接收
* ·安全性错误
* ·MAC重试次数

从网络层中使用由Thread的信息包括：

* ·IPv6地址丢失
* ·邻居表
* ·子表
* ·路由表

# **持久性数据**

---

在现场操作的设备可用于多种原因被意外地或故意复位。已重置设备，需要重新启动网络操作，无需用户干预。对于这个做需要一套信息被存储在非易失性存储器中。这包括：

·网络信息诸如PAN ID

·安全材料（每个键使用）

·从网络寻址信息以形成设备的IPv6地址


[/ref] http://www.jianshu.com/p/d041775b21b7 Thread协议栈基础
[/ref] Thread Stack Fundamentals_v2_public[pdf]
